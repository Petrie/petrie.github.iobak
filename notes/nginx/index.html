<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title> - Petrie&#39;s Home</title>
  

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta name="MobileOptimized" content="width"/>
<meta name="HandheldFriendly" content="true"/>


<meta name="applicable-device" content="pc,mobile">

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="mobile-web-app-capable" content="yes">

<meta name="author" content="petrie" />
  <meta name="description" content="Nginx Nginx cgi### CGI scripts is a way how to run a server side script when a HTTP request comes;CGI脚本是一种如何在服务端运行HTTP请求的方式
fastcgi### 比cgi更好的一种方式，GCI很慢，fastcgi更快
php-fpm### fastcgi的php实现
限流 限流算法令牌桶和漏桶对比：  令牌桶是按照固定速率往桶中添加令牌，请求是否被处理需要看桶中令牌是否足够，当令牌数减为零时则拒绝新的请求； 漏桶则是按照常量固定速率流出请求，流入请求速率任意，当流入的请求数累积到漏桶容量时，则新流入的请求被拒绝； 令牌桶限制的是平均流入速率（允许突发请求，只要有令牌就可以处理，支持一次拿3个令牌，4个令牌），并允许一定程度突发流量； 漏桶限制的是常量流出速率（即流出速率是一个固定常量值，比如都是1的速率流出，而不能一次是1，下次又是2），从而平滑突发流入速率； 令牌桶允许一定程度的突发，而漏桶主要目的是平滑流入速率；  配置优化性能篇 TCP优化 开启Gzip 开启缓存 配置选项## 虚拟主机与请求的转发 server_name匹配顺序
 首先选择所有字符串完全匹配的server_name，如www.testweb.com 其次选择通配符在前面的server_name，如*.testweb.com 再次选择通配符在后面的server_name，如www.testweb.* 最后选择使用正则表达式才匹配的server_name，如~^.testweb.com  location 匹配顺序
 = 表示把URI作为字符串，以便与参数中的uri做完全匹配。例如  location =/ { #只有用户请求是/时，才会使用location下的配置 }   ~表示匹配URI时是字母大小写敏感的。 ~*表示匹配URI是忽略字母大小写问题。 ^~表示匹配URI时只需要其前半部分与uri参数匹配即可。例如：  location ^~ /images/{ #以/images/开始的请求都会匹配上 }   @表示仅用于Nginx服务内部请求之间的重定向，带有@的location不直接处理用户请求。  文件路径定义 alias root  根据HTTP返回码重定向" />

  <meta name="keywords" content="Petrie, golang, php, swoole" />






<meta name="generator" content="Hugo 0.54-DEV" />


<link rel="canonical" href="http://petrie.github.io/notes/nginx/" />



<link rel="icon" href="/favicon.ico" />











<link rel="stylesheet" href="/sass/jane.min.c8c1ff75dee09b44060a6c38f41b9036bac2512ccdb22d7f296cec12dc786375.css" integrity="sha256-yMH/dd7gm0QGCmw49BuQNrrCUSzNsi1/KWzsEtx4Y3U=" media="screen" crossorigin="anonymous">





<meta property="og:title" content="" />
<meta property="og:description" content="Nginx Nginx cgi### CGI scripts is a way how to run a server side script when a HTTP request comes;CGI脚本是一种如何在服务端运行HTTP请求的方式
fastcgi### 比cgi更好的一种方式，GCI很慢，fastcgi更快
php-fpm### fastcgi的php实现
限流 限流算法令牌桶和漏桶对比：  令牌桶是按照固定速率往桶中添加令牌，请求是否被处理需要看桶中令牌是否足够，当令牌数减为零时则拒绝新的请求； 漏桶则是按照常量固定速率流出请求，流入请求速率任意，当流入的请求数累积到漏桶容量时，则新流入的请求被拒绝； 令牌桶限制的是平均流入速率（允许突发请求，只要有令牌就可以处理，支持一次拿3个令牌，4个令牌），并允许一定程度突发流量； 漏桶限制的是常量流出速率（即流出速率是一个固定常量值，比如都是1的速率流出，而不能一次是1，下次又是2），从而平滑突发流入速率； 令牌桶允许一定程度的突发，而漏桶主要目的是平滑流入速率；  配置优化性能篇 TCP优化 开启Gzip 开启缓存 配置选项## 虚拟主机与请求的转发 server_name匹配顺序
 首先选择所有字符串完全匹配的server_name，如www.testweb.com 其次选择通配符在前面的server_name，如*.testweb.com 再次选择通配符在后面的server_name，如www.testweb.* 最后选择使用正则表达式才匹配的server_name，如~^.testweb.com  location 匹配顺序
 = 表示把URI作为字符串，以便与参数中的uri做完全匹配。例如  location =/ { #只有用户请求是/时，才会使用location下的配置 }   ~表示匹配URI时是字母大小写敏感的。 ~*表示匹配URI是忽略字母大小写问题。 ^~表示匹配URI时只需要其前半部分与uri参数匹配即可。例如：  location ^~ /images/{ #以/images/开始的请求都会匹配上 }   @表示仅用于Nginx服务内部请求之间的重定向，带有@的location不直接处理用户请求。  文件路径定义 alias root  根据HTTP返回码重定向" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://petrie.github.io/notes/nginx/" />

<meta itemprop="name" content="">
<meta itemprop="description" content="Nginx Nginx cgi### CGI scripts is a way how to run a server side script when a HTTP request comes;CGI脚本是一种如何在服务端运行HTTP请求的方式
fastcgi### 比cgi更好的一种方式，GCI很慢，fastcgi更快
php-fpm### fastcgi的php实现
限流 限流算法令牌桶和漏桶对比：  令牌桶是按照固定速率往桶中添加令牌，请求是否被处理需要看桶中令牌是否足够，当令牌数减为零时则拒绝新的请求； 漏桶则是按照常量固定速率流出请求，流入请求速率任意，当流入的请求数累积到漏桶容量时，则新流入的请求被拒绝； 令牌桶限制的是平均流入速率（允许突发请求，只要有令牌就可以处理，支持一次拿3个令牌，4个令牌），并允许一定程度突发流量； 漏桶限制的是常量流出速率（即流出速率是一个固定常量值，比如都是1的速率流出，而不能一次是1，下次又是2），从而平滑突发流入速率； 令牌桶允许一定程度的突发，而漏桶主要目的是平滑流入速率；  配置优化性能篇 TCP优化 开启Gzip 开启缓存 配置选项## 虚拟主机与请求的转发 server_name匹配顺序
 首先选择所有字符串完全匹配的server_name，如www.testweb.com 其次选择通配符在前面的server_name，如*.testweb.com 再次选择通配符在后面的server_name，如www.testweb.* 最后选择使用正则表达式才匹配的server_name，如~^.testweb.com  location 匹配顺序
 = 表示把URI作为字符串，以便与参数中的uri做完全匹配。例如  location =/ { #只有用户请求是/时，才会使用location下的配置 }   ~表示匹配URI时是字母大小写敏感的。 ~*表示匹配URI是忽略字母大小写问题。 ^~表示匹配URI时只需要其前半部分与uri参数匹配即可。例如：  location ^~ /images/{ #以/images/开始的请求都会匹配上 }   @表示仅用于Nginx服务内部请求之间的重定向，带有@的location不直接处理用户请求。  文件路径定义 alias root  根据HTTP返回码重定向">



<meta itemprop="wordCount" content="210">



<meta itemprop="keywords" content="" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content=""/>
<meta name="twitter:description" content="Nginx Nginx cgi### CGI scripts is a way how to run a server side script when a HTTP request comes;CGI脚本是一种如何在服务端运行HTTP请求的方式
fastcgi### 比cgi更好的一种方式，GCI很慢，fastcgi更快
php-fpm### fastcgi的php实现
限流 限流算法令牌桶和漏桶对比：  令牌桶是按照固定速率往桶中添加令牌，请求是否被处理需要看桶中令牌是否足够，当令牌数减为零时则拒绝新的请求； 漏桶则是按照常量固定速率流出请求，流入请求速率任意，当流入的请求数累积到漏桶容量时，则新流入的请求被拒绝； 令牌桶限制的是平均流入速率（允许突发请求，只要有令牌就可以处理，支持一次拿3个令牌，4个令牌），并允许一定程度突发流量； 漏桶限制的是常量流出速率（即流出速率是一个固定常量值，比如都是1的速率流出，而不能一次是1，下次又是2），从而平滑突发流入速率； 令牌桶允许一定程度的突发，而漏桶主要目的是平滑流入速率；  配置优化性能篇 TCP优化 开启Gzip 开启缓存 配置选项## 虚拟主机与请求的转发 server_name匹配顺序
 首先选择所有字符串完全匹配的server_name，如www.testweb.com 其次选择通配符在前面的server_name，如*.testweb.com 再次选择通配符在后面的server_name，如www.testweb.* 最后选择使用正则表达式才匹配的server_name，如~^.testweb.com  location 匹配顺序
 = 表示把URI作为字符串，以便与参数中的uri做完全匹配。例如  location =/ { #只有用户请求是/时，才会使用location下的配置 }   ~表示匹配URI时是字母大小写敏感的。 ~*表示匹配URI是忽略字母大小写问题。 ^~表示匹配URI时只需要其前半部分与uri参数匹配即可。例如：  location ^~ /images/{ #以/images/开始的请求都会匹配上 }   @表示仅用于Nginx服务内部请求之间的重定向，带有@的location不直接处理用户请求。  文件路径定义 alias root  根据HTTP返回码重定向"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->




</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Petrie</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="http://petrie.github.io/">Home</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="http://petrie.github.io/post/">Archives</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="http://petrie.github.io/tags/">Tags</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="http://petrie.github.io/categories/">Categories</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="http://petrie.github.io/about/">About</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://gohugo.io" rel="noopener" target="_blank">
              external-link
              
              <i class="iconfont">
                <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M623.36 272.96 473.216 423.04C467.2 429.056 467.072 438.656 472.896 444.416c0 0-6.72-6.656 1.6 1.6C496.064 467.648 528.64 500.224 528.64 500.224 534.464 506.048 544 505.856 550.016 499.904l150.08-150.144 67.328 66.432c9.024 8.96 27.456 4.544 30.4-8.96 19.968-92.608 46.656-227.52 46.656-227.52 6.848-34.496-16.192-56.704-49.92-49.92 0 0-134.656 26.816-227.328 46.784C560.32 178.048 556.352 182.272 554.752 187.136c-3.2 6.208-3.008 14.208 3.776 20.992L623.36 272.96z"></path>
  <path d="M841.152 457.152c-30.528 0-54.784 24.512-54.784 54.656l0 274.752L237.696 786.56 237.696 237.696l206.016 0c6.656 0 10.752 0 13.248 0C487.68 237.696 512 213.184 512 182.848 512 152.32 487.36 128 456.96 128L183.04 128C153.216 128 128 152.576 128 182.848c0 3.136 0.256 6.272 0.768 9.28C128.256 195.136 128 198.272 128 201.408l0 639.488c0 0.064 0 0.192 0 0.256 0 0.128 0 0.192 0 0.32 0 30.528 24.512 54.784 54.784 54.784l646.976 0c6.592 0 9.728 0 11.712 0 28.736 0 52.928-22.976 54.464-51.968C896 843.264 896 842.304 896 841.344l0-20.352L896 561.408 896 512.128C896 481.792 871.424 457.152 841.152 457.152z"></path>
</svg>

              </i>
            </a>
          
        
      </li>
    
  </ul>
</nav>


  
    






  <link rel="stylesheet" href="/lib/photoswipe/photoswipe.min.css" />
  <link rel="stylesheet" href="/lib/photoswipe/default-skin/default-skin.min.css" />




<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

  

  

  <header id="header" class="header container">
    <div class="logo-wrapper">
  <a href="/" class="logo">
    
      Petrie
    
  </a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="http://petrie.github.io/">Home</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="http://petrie.github.io/post/">Archives</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="http://petrie.github.io/tags/">Tags</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="http://petrie.github.io/categories/">Categories</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="http://petrie.github.io/about/">About</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://gohugo.io" rel="noopener" target="_blank">
              external-link
              
              <i class="iconfont">
                <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M623.36 272.96 473.216 423.04C467.2 429.056 467.072 438.656 472.896 444.416c0 0-6.72-6.656 1.6 1.6C496.064 467.648 528.64 500.224 528.64 500.224 534.464 506.048 544 505.856 550.016 499.904l150.08-150.144 67.328 66.432c9.024 8.96 27.456 4.544 30.4-8.96 19.968-92.608 46.656-227.52 46.656-227.52 6.848-34.496-16.192-56.704-49.92-49.92 0 0-134.656 26.816-227.328 46.784C560.32 178.048 556.352 182.272 554.752 187.136c-3.2 6.208-3.008 14.208 3.776 20.992L623.36 272.96z"></path>
  <path d="M841.152 457.152c-30.528 0-54.784 24.512-54.784 54.656l0 274.752L237.696 786.56 237.696 237.696l206.016 0c6.656 0 10.752 0 13.248 0C487.68 237.696 512 213.184 512 182.848 512 152.32 487.36 128 456.96 128L183.04 128C153.216 128 128 152.576 128 182.848c0 3.136 0.256 6.272 0.768 9.28C128.256 195.136 128 198.272 128 201.408l0 639.488c0 0.064 0 0.192 0 0.256 0 0.128 0 0.192 0 0.32 0 30.528 24.512 54.784 54.784 54.784l646.976 0c6.592 0 9.728 0 11.712 0 28.736 0 52.928-22.976 54.464-51.968C896 843.264 896 842.304 896 841.344l0-20.352L896 561.408 896 512.128C896 481.792 871.424 457.152 841.152 457.152z"></path>
</svg>

              </i>
            </a>
          

        

      </li>
    
    
  </ul>
</nav>

  </header>

  <div id="mobile-panel">
    <main id="main" class="main bg-llight">
      <div class="content-wrapper">
        <div id="content" class="content container">
          <article class="post bg-white">
  
  <header class="post-header">
    <h1 class="post-title"></h1>
    
    <div class="post-meta">
      <time datetime="0001-01-01" class="post-time">
        0001-01-01
      </time>
    </div>
  </header>

  
  
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Table of Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
<ul>
<li><a href="#nginx">Nginx</a>
<ul>
<li><a href="#nginx-1">Nginx</a>
<ul>
<li><a href="#cgi">cgi###</a></li>
<li><a href="#fastcgi">fastcgi###</a></li>
<li><a href="#php-fpm">php-fpm###</a></li>
<li><a href="#限流">限流</a>
<ul>
<li><a href="#限流算法令牌桶和漏桶对比">限流算法令牌桶和漏桶对比：</a></li>
</ul></li>
<li><a href="#配置优化性能篇">配置优化性能篇</a>
<ul>
<li><a href="#tcp优化">TCP优化</a></li>
<li><a href="#开启gzip">开启Gzip</a></li>
<li><a href="#开启缓存">开启缓存</a></li>
</ul></li>
</ul></li>
<li><a href="#配置选项">配置选项##</a>
<ul>
<li>
<ul>
<li><a href="#虚拟主机与请求的转发">虚拟主机与请求的转发</a></li>
<li><a href="#文件路径定义">文件路径定义</a></li>
<li><a href="#内存及磁盘资源的分配">内存及磁盘资源的分配</a></li>
<li><a href="#网络连接的设置">网络连接的设置</a></li>
<li><a href="#reset-timeout-connection">reset_timeout_connection</a></li>
<li><a href="#mime类型的设置">MIME类型的设置</a></li>
<li><a href="#对客户端请求的限制">对客户端请求的限制</a></li>
<li><a href="#文件操作的优化">文件操作的优化</a></li>
<li><a href="#对客户端请求的特殊处理">对客户端请求的特殊处理</a></li>
</ul></li>
<li><a href="#开发一个简单的http模块">开发一个简单的HTTP模块</a>
<ul>
<li><a href="#准备工作">准备工作</a></li>
</ul></li>
</ul></li>
</ul></li>
</ul>
</nav>
  </div>
</div>

  
  <div class="post-content">
      

<h1 id="nginx">Nginx</h1>

<h2 id="nginx-1">Nginx</h2>

<h3 id="cgi">cgi###</h3>

<p>CGI scripts is a way how to run a server side script when a HTTP request comes;CGI脚本是一种如何在服务端运行HTTP请求的方式</p>

<h3 id="fastcgi">fastcgi###</h3>

<p>比cgi更好的一种方式，GCI很慢，fastcgi更快</p>

<h3 id="php-fpm">php-fpm###</h3>

<p>fastcgi的php实现</p>

<h3 id="限流">限流</h3>

<h4 id="限流算法令牌桶和漏桶对比">限流算法令牌桶和漏桶对比：</h4>

<ul>
<li>令牌桶是按照固定速率往桶中添加令牌，请求是否被处理需要看桶中令牌是否足够，当令牌数减为零时则拒绝新的请求；</li>
<li>漏桶则是按照常量固定速率流出请求，流入请求速率任意，当流入的请求数累积到漏桶容量时，则新流入的请求被拒绝；</li>
<li>令牌桶限制的是平均流入速率（允许突发请求，只要有令牌就可以处理，支持一次拿3个令牌，4个令牌），并允许一定程度突发流量；</li>
<li>漏桶限制的是常量流出速率（即流出速率是一个固定常量值，比如都是1的速率流出，而不能一次是1，下次又是2），从而平滑突发流入速率；</li>
<li>令牌桶允许一定程度的突发，而漏桶主要目的是平滑流入速率；</li>
</ul>

<h3 id="配置优化性能篇">配置优化性能篇</h3>

<h4 id="tcp优化">TCP优化</h4>

<h4 id="开启gzip">开启Gzip</h4>

<h4 id="开启缓存">开启缓存</h4>

<h2 id="配置选项">配置选项##</h2>

<h4 id="虚拟主机与请求的转发">虚拟主机与请求的转发</h4>

<p><strong>server_name匹配顺序</strong></p>

<ol>
<li>首先选择所有字符串完全匹配的server_name，如www.testweb.com</li>
<li>其次选择通配符在前面的server_name，如*.testweb.com</li>
<li>再次选择通配符在后面的server_name，如www.testweb.*</li>
<li>最后选择使用正则表达式才匹配的server_name，如~^.testweb.com</li>
</ol>

<p><strong>location 匹配顺序</strong></p>

<ol>
<li>= 表示把URI作为字符串，以便与参数中的uri做完全匹配。例如</li>
</ol>

<pre><code class="language-text">   location =/ {
     #只有用户请求是/时，才会使用location下的配置
   }
</code></pre>

<ol>
<li>~表示匹配URI时是字母大小写敏感的。</li>
<li>~*表示匹配URI是忽略字母大小写问题。</li>
<li>^~表示匹配URI时只需要其前半部分与uri参数匹配即可。例如：</li>
</ol>

<pre><code class="language-text">   location ^~ /images/{
     #以/images/开始的请求都会匹配上
   }
</code></pre>

<ol>
<li>@表示仅用于Nginx服务内部请求之间的重定向，带有@的location不直接处理用户请求。</li>
</ol>

<h4 id="文件路径定义">文件路径定义</h4>

<pre><code class="language-text">alias
root
</code></pre>

<p><strong>根据HTTP返回码重定向</strong></p>

<pre><code class="language-text">error_page    404             /404.html
error_page     502 503 504    /50x.html
error_page    403                http://example.com/forbidden.html;
error_page    404                =@fetch;
</code></pre>

<ul>
<li>重定义错误码</li>
</ul>

<pre><code class="language-text">  error_page    404    =200    /empty.gif
  error_page    404    =403    /forbidden.gif
</code></pre>

<ul>
<li>跳转后决定错误码</li>
</ul>

<pre><code class="language-text">  error_page 404    = /empty.gif
</code></pre>

<ul>
<li>如果不想修改URI，只是想让这样的请求重定向到另一个location中进行处理，那么可以这样设置“</li>
</ul>

<pre><code class="language-text">  location /{
    error_page     404
  }
</code></pre>

<p><strong>try_files</strong></p>

<p>尝试按照顺序访问每一个path，如果可以有效的读取，就直接向用户返回这个path对应的文件请求结束，否则继续向访问。**必须保证一个uri参数存在。</p>

<pre><code class="language-text">try_files /system/maintenace.html $uri $uri/index.html $uri.html @other;
location @other{
  proxy_pass    http://backend;
}
</code></pre>

<h4 id="内存及磁盘资源的分配">内存及磁盘资源的分配</h4>

<h4 id="网络连接的设置">网络连接的设置</h4>

<p><strong>发送响应的超时时间</strong></p>

<pre><code class="language-text">send_timeout 60
</code></pre>

<h4 id="reset-timeout-connection">reset_timeout_connection</h4>

<p>连接超时后将通过向客户端发送RST包来直接重置连接。不同过四次握手，相比于正常的方式，FIN_WAIT_1、FIN_WAIT_2、TIME_WAIT状态的TCP连接。</p>

<p>注意：使用RST重置包关闭连接会带来一些问题，默认情况下不会开启。</p>

<p><strong>lingering_time</strong></p>

<p>lingering_close起用后，这个配置对于上传大文件很有用，上文讲过，当用户请求的Content-Length大于max_client_body_size时，Nginx服务会立刻向用户发送413返回值，仍然持续不断的上传HTTP body，这时，经过了lingering_time设置后，Nginx将不管用户是否仍在上传，都会把连接关闭掉。</p>

<p><strong>lingering_timeout</strong></p>

<p><strong>keeplive_disale</strong></p>

<p>针对浏览器限制keepalive</p>

<pre><code class="language-text">keepalive_disable [msie6|safari|none]
</code></pre>

<p><strong>keepalive_timeout超时时间</strong></p>

<p>一个连接闲置超过一定时间后默认75s关闭。</p>

<p><strong>keepalive_requests</strong></p>

<p>一个keepalive长连接上允许承载的请求最大数.</p>

<p>一个keepalive连接上默认最多只能发送100个请求。</p>

<p><strong>tcp_nodelay</strong></p>

<p>确定对keepalive连接是否使用TCP_NODELAY选项</p>

<p><strong>tcp_nopush</strong></p>

<p>打开tcp_nopush后，将会在发送响应时把整个响应包头放到一个tcp包中发送。</p>

<h4 id="mime类型的设置">MIME类型的设置</h4>

<p><strong>mime映射</strong></p>

<pre><code class="language-text">types {
  text/html        html;
  text/html        conf;
  image/gif        gif;
  image/jpeg    jpg;
}
</code></pre>

<p><strong>默认MIME type</strong></p>

<pre><code class="language-text">default_type text/plain;
</code></pre>

<p>找不到相应的MIME type与文件扩展名之间的映射时，使用默认的MIME type作为HTTP header中的Content-Type。</p>

<h4 id="对客户端请求的限制">对客户端请求的限制</h4>

<p><strong>按照HTTP方法名限制用户请求</strong></p>

<pre><code class="language-text">limit_except method {...}
</code></pre>

<p><strong>HTTP请求包体的最大值</strong></p>

<pre><code class="language-text">client_max_body_size size
</code></pre>

<p><strong>对请求的限速limit_rate</strong></p>

<pre><code class="language-text">limit_rate speed;
</code></pre>

<p>请求限制每秒传输的字节数。</p>

<p><strong>limit_rate_after</strong></p>

<p>向客户端发送的响应长度超过limit_rate_after后才开始限速。</p>

<h4 id="文件操作的优化">文件操作的优化</h4>

<p><strong>sendfile 系统调用</strong></p>

<p>启用linux上的sendfile系统调用来发送文件，减少内核态禹用户态直接的内存复制，这样就会从磁盘读取文件后直接在内核态发送到网卡设备，提高了发送文件的效率。</p>

<p><strong>AIO系统调用</strong></p>

<p>是否在FreeBSD或Linux系统上启用内核级别的移步文件I/O功能。</p>

<p><strong>directio</strong></p>

<p>对大文件的读取速度有优化作用</p>

<p><strong>directio_alignment</strong></p>

<p><strong>打开文件缓存open_file_cache</strong></p>

<p>存储信息</p>

<ol>
<li>文件句柄、文件大小和上次修改时间</li>
<li>已经打开过的目录结构</li>
<li>没有找到或者没有权限操作的文件信息。</li>
</ol>

<p><strong>是否缓存文件错误的信息open_file_cache_errors</strong></p>

<p><strong>不被淘汰的最小访问次数</strong></p>

<p><strong>检验缓存中元素有效性的频率</strong></p>

<h4 id="对客户端请求的特殊处理">对客户端请求的特殊处理</h4>

<p><strong>忽略不合法的HTTP头部</strong></p>

<p><strong>HTTP头部是否允许下划线</strong></p>

<p><strong>对If-Modified-Since头部的处理策略</strong></p>

<p>服务器对比request中的if-modified-since时间，如果过期则返回内容，状态吗200，否则返回304 Not modified</p>

<p><strong>文件未找到时是否记录到error日志</strong></p>

<p><strong>DNS解析地址</strong></p>

<p><strong>DNS解析超时时间</strong></p>

<p><strong>返回错误页面时，是否在Server中注明Nginx版本</strong></p>

<h3 id="开发一个简单的http模块">开发一个简单的HTTP模块</h3>

<h4 id="准备工作">准备工作</h4>

<p><strong>整形的封装</strong></p>

<p><strong>ngx_str_t字符串</strong></p>

<p><strong>ngx_list_t 链表</strong></p>

<p><strong>ngx_table_elt_t HTTP头部</strong></p>

<p><strong>ngx_buf_t 处理大数据</strong></p>

<p><strong>ngx_chain_t</strong></p>

  </div>

  
  
<div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">Author</span>
    <span class="item-content">petrie</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">LastMod</span>
    <span class="item-content">0001-01-01</span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">License</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>


  
  
</article>




  
  

  

  

  
  
    



        </div>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  
  
    <a href="mailto:lpfvip2008@gmail.com" rel="me noopener" class="iconfont"
      title="email" >
      <svg class="icon" viewBox="0 0 1451 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M664.781909 681.472759 0 97.881301C0 3.997201 71.046997 0 71.046997 0L474.477909 0 961.649408 0 1361.641813 0C1361.641813 0 1432.688811 3.997201 1432.688811 97.881301L771.345323 681.472759C771.345323 681.472759 764.482731 685.154773 753.594283 688.65053L753.594283 688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858L682.561621 688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759L664.781909 681.472759ZM718.063616 811.603883C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633 0 212.052267 0 212.052267L0 942.809523C0 942.809523 0 1024 83.726336 1024L682.532949 1024 753.579947 1024 1348.948139 1024C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523L1432.688811 212.052267C1432.688811 212.052267 893.138176 701.759633 817.019477 767.734955 777.248 802.205449 742.347691 811.03081 718.063616 811.603883L718.063616 811.603883Z"></path>
</svg>

    </a>
  
    <a href="https://github.com/Petrie" rel="me noopener" class="iconfont"
      title="github"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M512 12.672c-282.88 0-512 229.248-512 512 0 226.261333 146.688 418.133333 350.08 485.76 25.6 4.821333 34.986667-11.008 34.986667-24.618667 0-12.16-0.426667-44.373333-0.64-87.04-142.421333 30.890667-172.458667-68.693333-172.458667-68.693333C188.672 770.986667 155.008 755.2 155.008 755.2c-46.378667-31.744 3.584-31.104 3.584-31.104 51.413333 3.584 78.421333 52.736 78.421333 52.736 45.653333 78.293333 119.850667 55.68 149.12 42.581333 4.608-33.109333 17.792-55.68 32.426667-68.48-113.706667-12.8-233.216-56.832-233.216-253.013333 0-55.893333 19.84-101.546667 52.693333-137.386667-5.76-12.928-23.04-64.981333 4.48-135.509333 0 0 42.88-13.738667 140.8 52.48 40.96-11.392 84.48-17.024 128-17.28 43.52 0.256 87.04 5.888 128 17.28 97.28-66.218667 140.16-52.48 140.16-52.48 27.52 70.528 10.24 122.581333 5.12 135.509333 32.64 35.84 52.48 81.493333 52.48 137.386667 0 196.693333-119.68 240-233.6 252.586667 17.92 15.36 34.56 46.762667 34.56 94.72 0 68.522667-0.64 123.562667-0.64 140.202666 0 13.44 8.96 29.44 35.2 24.32C877.44 942.592 1024 750.592 1024 524.672c0-282.752-229.248-512-512-512"></path>
</svg>

    </a>


<a href="http://petrie.github.io/index.xml" rel="noopener alternate" type="application/rss&#43;xml"
    class="iconfont" title="rss" target="_blank">
    <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="30" height="30">
  <path d="M819.157333 1024C819.157333 574.592 449.408 204.8 0 204.8V0c561.706667 0 1024 462.293333 1024 1024h-204.842667zM140.416 743.04a140.8 140.8 0 0 1 140.501333 140.586667A140.928 140.928 0 0 1 140.074667 1024C62.72 1024 0 961.109333 0 883.626667s62.933333-140.544 140.416-140.586667zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667V345.173333c372.352 0 678.784 306.517333 678.784 678.826667z"></path>
</svg>

  </a>
  
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - <a class="theme-link" href="https://github.com/xianmin/hugo-theme-jane">Jane</a>
  </span>

  <span class="copyright-year">
    &copy;
    
      2015 -
    2020
    <span class="heart">
      
      <i class="iconfont">
        <svg class="icon" viewBox="0 0 1025 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="14" height="14">
  <path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7 0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1 0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2 0.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2 0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3 0.1-42.5-8-83.6-24-122.2z"
   fill="#8a8a8a"></path>
</svg>

      </i>
    </span><span class="author">
        petrie
        
      </span></span>

  
  
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont">
        
        <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="35" height="35">
  <path d="M510.866688 227.694839 95.449397 629.218702l235.761562 0-2.057869 328.796468 362.40389 0L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777l894.052392 0 0 131.813095L63.840492 195.775872 63.840492 63.962777 63.840492 63.962777zM63.840492 63.962777"></path>
</svg>

      </i>
    </div>
  </div>
  
<script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>




<script type="text/javascript" src="/js/main.638251f4230630f0335d8c6748e53a96f94b72670920b60c09a56fdc8bece214.js" integrity="sha256-Y4JR9CMGMPAzXYxnSOU6lvlLcmcJILYMCaVv3Ivs4hQ=" crossorigin="anonymous"></script>






  
    <script type="text/javascript" src="/js/load-photoswipe.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe.min.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe-ui-default.min.js"></script>
  













</body>
</html>
